{"version":3,"sources":["../../../src/install/checkPackages.ts"],"sourcesContent":["import { getConfig } from '@expo/config';\nimport * as PackageManager from '@expo/package-manager';\nimport chalk from 'chalk';\n\nimport { fixPackagesAsync } from './fixPackages';\nimport { Options } from './resolveOptions';\nimport * as Log from '../log';\nimport {\n  getVersionedDependenciesAsync,\n  logIncorrectDependencies,\n} from '../start/doctor/dependencies/validateDependenciesVersions';\nimport { isInteractive } from '../utils/interactive';\nimport { learnMore } from '../utils/link';\nimport { confirmAsync } from '../utils/prompts';\nimport { joinWithCommasAnd } from '../utils/strings';\n\nconst debug = require('debug')('expo:install:check') as typeof console.log;\n\n/**\n * Handles `expo install --fix|check'.\n * Checks installed dependencies against bundledNativeModules and versions endpoints to find any incompatibilities.\n * If `--fix` is passed, it will install the correct versions of the dependencies.\n * If `--check` is passed, it will prompt the user to install the correct versions of the dependencies (on interactive terminal).\n */\nexport async function checkPackagesAsync(\n  projectRoot: string,\n  {\n    packages,\n    packageManager,\n    options: { fix },\n    packageManagerArguments,\n  }: {\n    /**\n     * List of packages to version\n     * @example ['uuid', 'react-native-reanimated@latest']\n     */\n    packages: string[];\n    /** Package manager to use when installing the versioned packages. */\n    packageManager: PackageManager.NodePackageManager;\n\n    /** How the check should resolve */\n    options: Pick<Options, 'fix'>;\n    /**\n     * Extra parameters to pass to the `packageManager` when installing versioned packages.\n     * @example ['--no-save']\n     */\n    packageManagerArguments: string[];\n  }\n) {\n  // Read the project Expo config without plugins.\n  const { exp, pkg } = getConfig(projectRoot, {\n    // Sometimes users will add a plugin to the config before installing the library,\n    // this wouldn't work unless we dangerously disable plugin serialization.\n    skipPlugins: true,\n  });\n\n  if (pkg.expo?.install?.exclude?.length) {\n    Log.log(\n      chalk`Skipped ${fix ? 'fixing' : 'checking'} dependencies: ${joinWithCommasAnd(\n        pkg.expo.install.exclude\n      )}. These dependencies are listed in {bold expo.install.exclude} in package.json. ${learnMore(\n        'https://docs.expo.dev/more/expo-cli/#configuring-dependency-validation'\n      )}`\n    );\n  }\n\n  const dependencies = await getVersionedDependenciesAsync(projectRoot, exp, pkg, packages);\n\n  /*\n   * Expo Router projects will do this additional check\n   * Note: The e2e tests use nexpo which will always resolve 'expo-router/doctor.js'\n   *       For that reason, you cannot use nexpo to test for the sub-dependency check,\n   *       and you cannot replace this guard with a try/catch around the import('expo-router')\n   */\n  if (pkg.dependencies?.['expo-router']) {\n    try {\n      const { doctor: routerDoctor } = await import('expo-router/doctor.js');\n      dependencies.push(\n        ...routerDoctor(pkg, require.resolve('@react-navigation/native'), {\n          bold: chalk.bold,\n          learnMore,\n        })\n      );\n    } catch (error) {\n      Log.log(`Skipped checking expo-router dependencies: expo-router/doctor.js not found.`);\n      debug('expo-router/doctor error:', error);\n    }\n  }\n\n  if (!dependencies.length) {\n    Log.exit(chalk.greenBright('Dependencies are up to date'), 0);\n  }\n\n  logIncorrectDependencies(dependencies);\n\n  const value =\n    // If `--fix` then always fix.\n    fix ||\n    // Otherwise prompt to fix when not running in CI.\n    (isInteractive() && (await confirmAsync({ message: 'Fix dependencies?' }).catch(() => false)));\n\n  if (value) {\n    debug('Installing fixed dependencies:', dependencies);\n    // Install the corrected dependencies.\n    return fixPackagesAsync(projectRoot, {\n      packageManager,\n      packages: dependencies,\n      packageManagerArguments,\n      sdkVersion: exp.sdkVersion!,\n    });\n  }\n\n  // Exit with non-zero exit code if any of the dependencies are out of date.\n  Log.exit(chalk.red('Found outdated dependencies'), 1);\n}\n"],"names":["checkPackagesAsync","debug","require","projectRoot","packages","packageManager","options","fix","packageManagerArguments","pkg","exp","getConfig","skipPlugins","expo","install","exclude","length","Log","log","chalk","joinWithCommasAnd","learnMore","dependencies","getVersionedDependenciesAsync","doctor","routerDoctor","push","resolve","bold","error","exit","greenBright","logIncorrectDependencies","value","isInteractive","confirmAsync","message","catch","fixPackagesAsync","sdkVersion","red"],"mappings":"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"}