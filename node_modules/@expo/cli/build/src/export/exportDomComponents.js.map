{"version":3,"sources":["../../../src/export/exportDomComponents.ts"],"sourcesContent":["import type { ExpoConfig } from '@expo/config';\nimport assert from 'assert';\nimport crypto from 'crypto';\nimport path from 'path';\nimport resolveFrom from 'resolve-from';\nimport url from 'url';\n\nimport { type PlatformMetadata } from './createMetadataJson';\nimport { type BundleOutput, type ExportAssetMap, getFilesFromSerialAssets } from './saveAssets';\nimport { type MetroBundlerDevServer } from '../start/server/metro/MetroBundlerDevServer';\nimport { serializeHtmlWithAssets } from '../start/server/metro/serializeHtml';\nimport {\n  getDomComponentHtml,\n  DOM_COMPONENTS_BUNDLE_DIR,\n} from '../start/server/middleware/DomComponentsMiddleware';\nimport { env } from '../utils/env';\nimport { resolveRealEntryFilePath, toPosixPath } from '../utils/filePath';\n\nconst debug = require('debug')('expo:export:exportDomComponents') as typeof console.log;\n\n// TODO(EvanBacon): determine how to support DOM Components with hosting.\nexport async function exportDomComponentAsync({\n  filePath,\n  projectRoot,\n  dev,\n  devServer,\n  isHermes,\n  includeSourceMaps,\n  exp,\n  files,\n}: {\n  filePath: string;\n  projectRoot: string;\n  dev: boolean;\n  devServer: MetroBundlerDevServer;\n  isHermes: boolean;\n  includeSourceMaps: boolean;\n  exp: ExpoConfig;\n  files: ExportAssetMap;\n}): Promise<{\n  bundle: BundleOutput;\n  htmlOutputName: string;\n}> {\n  const virtualEntry = toPosixPath(resolveFrom(projectRoot, 'expo/dom/entry.js'));\n  debug('Bundle DOM Component:', filePath);\n  // MUST MATCH THE BABEL PLUGIN!\n  const hash = crypto.createHash('sha1').update(filePath).digest('hex');\n  const outputName = `${DOM_COMPONENTS_BUNDLE_DIR}/${hash}.html`;\n  const generatedEntryPath = toPosixPath(\n    filePath.startsWith('file://') ? url.fileURLToPath(filePath) : filePath\n  );\n  const baseUrl = `/${DOM_COMPONENTS_BUNDLE_DIR}`;\n  // The relative import path will be used like URI so it must be POSIX.\n  const relativeImport = './' + path.posix.relative(path.dirname(virtualEntry), generatedEntryPath);\n  // Run metro bundler and create the JS bundles/source maps.\n  const bundle = await devServer.legacySinglePageExportBundleAsync({\n    platform: 'web',\n    domRoot: encodeURI(relativeImport),\n    splitChunks: !env.EXPO_NO_BUNDLE_SPLITTING,\n    mainModuleName: resolveRealEntryFilePath(projectRoot, virtualEntry),\n    mode: dev ? 'development' : 'production',\n    engine: isHermes ? 'hermes' : undefined,\n    serializerIncludeMaps: includeSourceMaps,\n    bytecode: false,\n    reactCompiler: !!exp.experiments?.reactCompiler,\n    baseUrl: './',\n    // Minify may be false because it's skipped on native when Hermes is enabled, default to true.\n    minify: true,\n  });\n\n  const html = await serializeHtmlWithAssets({\n    isExporting: true,\n    resources: bundle.artifacts,\n    template: getDomComponentHtml(),\n    baseUrl: './',\n  });\n\n  const serialAssets = bundle.artifacts.map((a) => {\n    return {\n      ...a,\n      filename: path.join(baseUrl, a.filename),\n    };\n  });\n\n  getFilesFromSerialAssets(serialAssets, {\n    includeSourceMaps,\n    files,\n    platform: 'web',\n  });\n\n  files.set(outputName, {\n    contents: html,\n  });\n\n  return {\n    bundle,\n    htmlOutputName: outputName,\n  };\n}\n\n/**\n * For EAS Updates exports,\n * post-processes the DOM component bundle and updates the asset paths to use flattened MD5 naming.\n */\nexport function updateDomComponentAssetsForMD5Naming({\n  domComponentReference,\n  nativeBundle,\n  domComponentBundle,\n  files,\n  htmlOutputName,\n}: {\n  domComponentReference: string;\n  nativeBundle: BundleOutput;\n  domComponentBundle: BundleOutput;\n  files: ExportAssetMap;\n  htmlOutputName: string;\n}): PlatformMetadata['assets'] {\n  const assetsMetadata: PlatformMetadata['assets'] = [];\n\n  for (const artifact of domComponentBundle.artifacts) {\n    if (artifact.type !== 'js') {\n      continue;\n    }\n    const artifactAssetName = `/${DOM_COMPONENTS_BUNDLE_DIR}/${artifact.filename}`;\n    let source = artifact.source;\n\n    // [0] Updates asset paths in the DOM component JS bundle (which is a web bundle)\n    for (const asset of domComponentBundle.assets) {\n      const prefix = asset.httpServerLocation.startsWith('./')\n        ? asset.httpServerLocation.slice(2)\n        : asset.httpServerLocation;\n      const uri = `${prefix}/${asset.name}.${asset.type}`;\n      const regexp = new RegExp(`(uri:\")(${uri})(\")`, 'g');\n      const index = asset.scales.findIndex((s) => s === 1) ?? 0; // DOM components (web) uses 1x assets\n      const md5 = asset.fileHashes[index];\n      source = source.replace(regexp, `$1${md5}.${asset.type}$3`);\n\n      const domJsAssetEntity = files.get(artifactAssetName);\n      assert(domJsAssetEntity);\n      domJsAssetEntity.contents = source;\n    }\n\n    // [1] Updates JS artifacts in HTML\n    const md5 = crypto.createHash('md5').update(source).digest('hex');\n    const htmlAssetEntity = files.get(htmlOutputName);\n    assert(htmlAssetEntity);\n    const regexp = new RegExp(`(<script src=\")(.*${artifact.filename})(\" defer></script>)`, 'g');\n    htmlAssetEntity.contents = htmlAssetEntity.contents.toString().replace(regexp, `$1${md5}.js$3`);\n\n    assetsMetadata.push({\n      path: artifactAssetName.slice(1),\n      ext: 'js',\n    });\n  }\n\n  // [2] Updates HTML names from native bundle\n  const htmlContent = files.get(htmlOutputName);\n  assert(htmlContent);\n  const htmlMd5 = crypto.createHash('md5').update(htmlContent.contents.toString()).digest('hex');\n  const hash = crypto.createHash('sha1').update(domComponentReference).digest('hex');\n  for (const artifact of nativeBundle.artifacts) {\n    if (artifact.type !== 'js') {\n      continue;\n    }\n    const assetEntity = files.get(artifact.filename);\n    assert(assetEntity);\n    const regexp = new RegExp(`(['\"])${hash}\\\\.html(['\"])`, 'g');\n    assetEntity.contents = assetEntity.contents.toString().replace(regexp, `$1${htmlMd5}.html$2`);\n  }\n  assetsMetadata.push({\n    path: htmlOutputName,\n    ext: 'html',\n  });\n\n  return assetsMetadata;\n}\n"],"names":["exportDomComponentAsync","updateDomComponentAssetsForMD5Naming","debug","require","filePath","projectRoot","dev","devServer","isHermes","includeSourceMaps","exp","files","virtualEntry","toPosixPath","resolveFrom","hash","crypto","createHash","update","digest","outputName","DOM_COMPONENTS_BUNDLE_DIR","generatedEntryPath","startsWith","url","fileURLToPath","baseUrl","relativeImport","path","posix","relative","dirname","bundle","legacySinglePageExportBundleAsync","platform","domRoot","encodeURI","splitChunks","env","EXPO_NO_BUNDLE_SPLITTING","mainModuleName","resolveRealEntryFilePath","mode","engine","undefined","serializerIncludeMaps","bytecode","reactCompiler","experiments","minify","html","serializeHtmlWithAssets","isExporting","resources","artifacts","template","getDomComponentHtml","serialAssets","map","a","filename","join","getFilesFromSerialAssets","set","contents","htmlOutputName","domComponentReference","nativeBundle","domComponentBundle","assetsMetadata","artifact","type","artifactAssetName","source","asset","assets","prefix","httpServerLocation","slice","uri","name","regexp","RegExp","index","scales","findIndex","s","md5","fileHashes","replace","domJsAssetEntity","get","assert","htmlAssetEntity","toString","push","ext","htmlContent","htmlMd5","assetEntity"],"mappings":"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"}