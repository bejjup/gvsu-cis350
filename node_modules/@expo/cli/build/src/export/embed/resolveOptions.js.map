{"version":3,"sources":["../../../../src/export/embed/resolveOptions.ts"],"sourcesContent":["import { resolveEntryPoint } from '@expo/config/paths';\nimport arg from 'arg';\nimport type { OutputOptions } from 'metro/src/shared/types';\nimport canonicalize from 'metro-core/src/canonicalize';\nimport os from 'os';\nimport path from 'path';\n\nimport { env } from '../../utils/env';\nimport { CommandError } from '../../utils/errors';\nimport { resolveCustomBooleanArgsAsync } from '../../utils/resolveArgs';\nimport { isAndroidUsingHermes, isIosUsingHermes } from '../exportHermes';\n\nexport interface Options {\n  assetsDest?: string;\n  assetCatalogDest?: string;\n  entryFile: string;\n  resetCache: boolean;\n  transformer?: string;\n  minify?: boolean;\n  config?: string;\n  platform: string;\n  dev: boolean;\n  bundleOutput: string;\n  bundleEncoding?: OutputOptions['bundleEncoding'];\n  maxWorkers?: number;\n  sourcemapOutput?: string;\n  sourcemapSourcesRoot?: string;\n  sourcemapUseAbsolutePath: boolean;\n  verbose: boolean;\n  unstableTransformProfile?: string;\n  eager?: boolean;\n}\n\nfunction assertIsBoolean(val: any): asserts val is boolean {\n  if (typeof val !== 'boolean') {\n    throw new CommandError(`Expected boolean, got ${typeof val}`);\n  }\n}\n\nfunction getBundleEncoding(encoding: string | undefined): OutputOptions['bundleEncoding'] {\n  return encoding === 'utf8' || encoding === 'utf16le' || encoding === 'ascii'\n    ? encoding\n    : undefined;\n}\n\nexport function resolveOptions(\n  projectRoot: string,\n  args: arg.Result<arg.Spec>,\n  parsed: Awaited<ReturnType<typeof resolveCustomBooleanArgsAsync>>\n): Options {\n  const dev = parsed.args['--dev'] ?? true;\n  assertIsBoolean(dev);\n\n  const platform = args['--platform'];\n  if (!platform) {\n    throw new CommandError(`Missing required argument: --platform`);\n  }\n\n  const bundleOutput = args['--bundle-output'];\n\n  const commonOptions = {\n    entryFile: args['--entry-file'] ?? resolveEntryPoint(projectRoot, { platform }),\n    assetCatalogDest: args['--asset-catalog-dest'],\n    platform,\n    transformer: args['--transformer'],\n    // TODO: Support `--dev false`\n    //   dev: false,\n    bundleOutput,\n    bundleEncoding: getBundleEncoding(args['--bundle-encoding']) ?? 'utf8',\n    maxWorkers: args['--max-workers'],\n    sourcemapOutput: args['--sourcemap-output'],\n    sourcemapSourcesRoot: args['--sourcemap-sources-root'],\n    sourcemapUseAbsolutePath: !!parsed.args['--sourcemap-use-absolute-path'],\n    assetsDest: args['--assets-dest'],\n    unstableTransformProfile: args['--unstable-transform-profile'],\n    resetCache: !!parsed.args['--reset-cache'],\n    verbose: args['--verbose'] ?? env.EXPO_DEBUG,\n    config: args['--config'] ? path.resolve(args['--config']) : undefined,\n    dev,\n    minify: parsed.args['--minify'] as boolean | undefined,\n    eager: !!parsed.args['--eager'],\n  };\n\n  if (commonOptions.eager) {\n    return resolveEagerOptionsAsync(projectRoot, commonOptions);\n  }\n\n  // Perform extra assertions after the eager options are resolved.\n\n  if (!bundleOutput) {\n    throw new CommandError(`Missing required argument: --bundle-output`);\n  }\n\n  const minify = parsed.args['--minify'] ?? !dev;\n  assertIsBoolean(minify);\n\n  return { ...commonOptions, minify, bundleOutput };\n}\n\nfunction getTemporaryPath() {\n  return path.join(os.tmpdir(), Math.random().toString(36).substring(2));\n}\n\n/** Best effort guess of which options will be used for the export:embed invocation that is called from the native build scripts. */\nexport function resolveEagerOptionsAsync(\n  projectRoot: string,\n  {\n    dev,\n    platform,\n    assetsDest,\n    bundleOutput,\n    minify,\n    ...options\n  }: Partial<Omit<Options, 'platform' | 'dev'>> & {\n    platform: string;\n    dev: boolean;\n  }\n): Options {\n  // If the minify prop is undefined, then check if the project is using hermes.\n  minify ??= !(platform === 'android'\n    ? isAndroidUsingHermes(projectRoot)\n    : isIosUsingHermes(projectRoot));\n\n  let destination: string | undefined;\n\n  if (!assetsDest) {\n    destination ??= getTemporaryPath();\n    assetsDest = path.join(destination, 'assets');\n  }\n\n  if (!bundleOutput) {\n    destination ??= getTemporaryPath();\n    bundleOutput =\n      platform === 'ios'\n        ? path.join(destination, 'main.jsbundle')\n        : path.join(destination, 'index.js');\n  }\n\n  return {\n    ...options,\n    eager: options.eager ?? true,\n    bundleOutput,\n    assetsDest,\n    entryFile: options.entryFile ?? resolveEntryPoint(projectRoot, { platform }),\n    resetCache: !!options.resetCache,\n    platform,\n    minify,\n    dev,\n    bundleEncoding: 'utf8',\n    sourcemapUseAbsolutePath: false,\n    verbose: env.EXPO_DEBUG,\n  };\n}\n\nexport function getExportEmbedOptionsKey({\n  // Extract all values that won't change the Metro results.\n  resetCache,\n  assetsDest,\n  bundleOutput,\n  verbose,\n  maxWorkers,\n  eager,\n  ...options\n}: Options) {\n  // Create a sorted key for the options, removing values that won't change the Metro results.\n  return JSON.stringify(options, canonicalize);\n}\n\nexport function deserializeEagerKey(key: string) {\n  return JSON.parse(key) as { options: Options; key: string };\n}\n"],"names":["resolveOptions","resolveEagerOptionsAsync","getExportEmbedOptionsKey","deserializeEagerKey","assertIsBoolean","val","CommandError","getBundleEncoding","encoding","undefined","projectRoot","args","parsed","dev","platform","bundleOutput","commonOptions","entryFile","resolveEntryPoint","assetCatalogDest","transformer","bundleEncoding","maxWorkers","sourcemapOutput","sourcemapSourcesRoot","sourcemapUseAbsolutePath","assetsDest","unstableTransformProfile","resetCache","verbose","env","EXPO_DEBUG","config","path","resolve","minify","eager","getTemporaryPath","join","os","tmpdir","Math","random","toString","substring","options","isAndroidUsingHermes","isIosUsingHermes","destination","JSON","stringify","canonicalize","key","parse"],"mappings":"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"}